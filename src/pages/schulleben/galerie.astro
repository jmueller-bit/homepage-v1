---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Hero from '../../components/Hero.astro';
import Section from '../../components/Section.astro';
import { getAllGalleryImages } from '../../lib/contentful';

const images = await getAllGalleryImages(100);

// Get unique categories
const categories = [...new Set(images.map(img => img.category || 'Allgemein'))];
---

<BaseLayout title="Galerie">
  <Hero
    title="Bilder aus dem <span class='hero-title-accent'>Schulleben</span>"
    description="Eindr√ºcke von unseren Projekten, Festen und Ausfl√ºgen."
    badge="Impressionen"
  />

  <Section>
    <!-- Filter Buttons -->
    <div class="filter-container">
      <button class="filter-btn active" data-filter="all">
        <span class="filter-icon">üñºÔ∏è</span>
        Alle
        <span class="filter-count">({images.length})</span>
      </button>
      {categories.map((category) => {
        const count = images.filter(img => (img.category || 'Allgemein') === category).length;
        return (
          <button class="filter-btn" data-filter={category}>
            <span class="filter-icon">
              {category === 'unterricht' ? 'üìö' : 
               category === 'events' ? 'üéâ' : 
               category === 'sport' ? '‚öΩ' : 'üìÅ'}
            </span>
            {category.charAt(0).toUpperCase() + category.slice(1)}
            <span class="filter-count">({count})</span>
          </button>
        );
      })}
    </div>

    <!-- Gallery Grid -->
    <div class="gallery-grid" id="galleryGrid">
      {images.length === 0 ? (
        <div class="empty-state">
          <div class="empty-icon">üì∑</div>
          <h3>Noch keine Bilder</h3>
          <p>Bald gibt es hier Bilder zu sehen!</p>
        </div>
      ) : (
        images.map((image, index) => (
          <div 
            class="gallery-item" 
            data-category={image.category || 'Allgemein'}
            data-index={index}
          >
            <img 
              src={image.src} 
              alt={image.alt}
              loading="lazy"
              class="gallery-img"
            />
            <div class="gallery-overlay">
              <span class="image-title">{image.title}</span>
              <span class="image-category">{image.category || 'Allgemein'}</span>
            </div>
          </div>
        ))
      )}
    </div>
  </Section>

  <!-- Lightbox -->
  <div id="lightbox" class="lightbox" style="display: none;">
    <button class="lightbox-close" id="lightboxClose" aria-label="Schlie√üen">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M18 6L6 18M6 6l12 12"/>
      </svg>
    </button>
    
    <button class="lightbox-nav prev" id="lightboxPrev" aria-label="Vorheriges Bild">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M15 18l-6-6 6-6"/>
      </svg>
    </button>
    
    <button class="lightbox-nav next" id="lightboxNext" aria-label="N√§chstes Bild">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M9 18l6-6-6-6"/>
      </svg>
    </button>

    <div class="lightbox-content">
      <img id="lightboxImage" src="" alt="" class="lightbox-img"/>
      <div class="lightbox-info">
        <h3 id="lightboxTitle"></h3>
        <span id="lightboxCounter"></span>
      </div>
    </div>
  </div>
</BaseLayout>

<script is:inline define:vars={{ imagesData: JSON.stringify(images), categoriesData: JSON.stringify(categories) }}>
  // Parse JSON data
  const images = JSON.parse(imagesData);
  const categories = JSON.parse(categoriesData);
  
  // Debug info
  console.log('Gallery loaded with', images.length, 'images');
  console.log('Categories:', categories);
  console.log('First image:', images[0]);
  
  let currentIndex = 0;
  let filteredImages = [...images];
  
  console.log('Initial filteredImages length:', filteredImages.length);

  // Filter functionality
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const filter = btn.dataset.filter;
      
      // Update active button
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      // Filter images
      if (filter === 'all') {
        filteredImages = [...images];
      } else {
        filteredImages = images.filter(img => (img.category || 'Allgemein') === filter);
      }
      
      console.log('Filter changed to:', filter, '- showing', filteredImages.length, 'images');
      
      // Show/hide gallery items
      document.querySelectorAll('.gallery-item').forEach(item => {
        if (filter === 'all' || item.dataset.category === filter) {
          item.style.display = 'block';
        } else {
          item.style.display = 'none';
        }
      });
    });
  });

  // Open lightbox - use event delegation for better reliability
  document.getElementById('galleryGrid').addEventListener('click', (e) => {
    const item = e.target.closest('.gallery-item');
    if (!item) return;
    
    const index = parseInt(item.dataset.index);
    console.log('Clicked image index:', index);
    console.log('Current filteredImages length:', filteredImages.length);
    
    // Find the image that was clicked
    const clickedImage = images[index];
    if (!clickedImage) {
      console.error('Image not found at index', index);
      return;
    }
    
    console.log('Clicked image:', clickedImage);
    console.log('Image ID:', clickedImage.id);
    
    // Find index in filtered images by ID
    currentIndex = filteredImages.findIndex(img => img.id === clickedImage.id);
    
    console.log('Found index in filteredImages:', currentIndex);
    
    if (currentIndex === -1) {
      console.warn('Image not found in filtered images, showing first image');
      currentIndex = 0;
    }
    
    console.log('Opening lightbox at index:', currentIndex, 'of', filteredImages.length);
    openLightbox();
  });

  function openLightbox() {
    const lightbox = document.getElementById('lightbox');
    if (!lightbox) {
      console.error('Lightbox element not found');
      return;
    }
    updateLightboxImage();
    lightbox.style.display = 'flex';
    lightbox.classList.add('active');
    document.body.style.overflow = 'hidden';
    console.log('Lightbox opened');
  }

  function closeLightbox() {
    const lightbox = document.getElementById('lightbox');
    if (!lightbox) return;
    lightbox.classList.remove('active');
    lightbox.style.display = 'none';
    document.body.style.overflow = '';
    console.log('Lightbox closed');
  }

  function updateLightboxImage() {
    const image = filteredImages[currentIndex];
    if (!image) return;
    
    document.getElementById('lightboxImage').src = image.src;
    document.getElementById('lightboxImage').alt = image.alt;
    document.getElementById('lightboxTitle').textContent = image.title;
    document.getElementById('lightboxCounter').textContent = `${currentIndex + 1} / ${filteredImages.length}`;
  }

  function nextImage() {
    currentIndex = (currentIndex + 1) % filteredImages.length;
    updateLightboxImage();
  }

  function prevImage() {
    currentIndex = (currentIndex - 1 + filteredImages.length) % filteredImages.length;
    updateLightboxImage();
  }

  // Event listeners
  document.getElementById('lightboxClose').addEventListener('click', closeLightbox);
  document.getElementById('lightboxNext').addEventListener('click', (e) => { e.stopPropagation(); nextImage(); });
  document.getElementById('lightboxPrev').addEventListener('click', (e) => { e.stopPropagation(); prevImage(); });
  
  // Close on backdrop click
  document.getElementById('lightbox').addEventListener('click', (e) => {
    if (e.target === document.getElementById('lightbox')) {
      closeLightbox();
    }
  });

  // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (!document.getElementById('lightbox').classList.contains('active')) return;
    
    if (e.key === 'Escape') closeLightbox();
    if (e.key === 'ArrowRight') nextImage();
    if (e.key === 'ArrowLeft') prevImage();
  });
</script>

<style>
  .filter-container {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-bottom: 2.5rem;
    justify-content: center;
  }

  .filter-btn {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.25rem;
    background: white;
    border: 2px solid var(--color-gray-200);
    border-radius: 2rem;
    font-size: 0.9rem;
    font-weight: 500;
    color: var(--color-gray-600);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .filter-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .filter-btn.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
  }

  .filter-icon {
    font-size: 1.1rem;
  }

  .filter-count {
    font-size: 0.8rem;
    opacity: 0.7;
  }

  /* Gallery Grid */
  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .gallery-item {
    position: relative;
    border-radius: 0.75rem;
    overflow: hidden;
    aspect-ratio: 4/3;
    background: var(--color-gray-200);
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .gallery-item:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
  }

  .gallery-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transition: transform 0.3s ease;
  }

  .gallery-item:hover .gallery-img {
    transform: scale(1.05);
  }

  .gallery-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 1.5rem;
    background: linear-gradient(transparent, rgba(0, 0, 0, 0.7));
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .gallery-item:hover .gallery-overlay {
    opacity: 1;
  }

  .image-title {
    color: white;
    font-weight: 600;
    font-size: 0.95rem;
    display: block;
    margin-bottom: 0.25rem;
  }

  .image-category {
    color: rgba(255, 255, 255, 0.8);
    font-size: 0.8rem;
    text-transform: capitalize;
  }

  /* Empty State */
  .empty-state {
    grid-column: 1 / -1;
    text-align: center;
    padding: 4rem 2rem;
  }

  .empty-icon {
    font-size: 4rem;
    margin-bottom: 1rem;
  }

  .empty-state h3 {
    font-size: 1.5rem;
    color: var(--color-gray-700);
    margin-bottom: 0.5rem;
  }

  .empty-state p {
    color: var(--color-gray-500);
  }

  /* Lightbox */
  .lightbox {
    position: fixed;
    inset: 0;
    z-index: 1000;
    background: rgba(0, 0, 0, 0.95);
    align-items: center;
    justify-content: center;
  }

  .lightbox.active {
    display: flex !important;
  }

  .lightbox-close {
    position: absolute;
    top: 1.5rem;
    right: 1.5rem;
    width: 48px;
    height: 48px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 1001;
  }

  .lightbox-close:hover {
    background: rgba(255, 255, 255, 0.2);
    transform: rotate(90deg);
  }

  .lightbox-close svg {
    width: 24px;
    height: 24px;
  }

  .lightbox-nav {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 56px;
    height: 56px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    color: white;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 1001;
  }

  .lightbox-nav:hover {
    background: rgba(255, 255, 255, 0.2);
  }

  .lightbox-nav.prev {
    left: 1.5rem;
  }

  .lightbox-nav.next {
    right: 1.5rem;
  }

  .lightbox-nav svg {
    width: 28px;
    height: 28px;
  }

  .lightbox-content {
    max-width: 90vw;
    max-height: 90vh;
    text-align: center;
  }

  .lightbox-img {
    max-width: 100%;
    max-height: 80vh;
    object-fit: contain;
    border-radius: 0.5rem;
  }

  .lightbox-info {
    margin-top: 1rem;
    color: white;
  }

  .lightbox-info h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0.5rem;
  }

  #lightboxCounter {
    color: rgba(255, 255, 255, 0.7);
    font-size: 0.9rem;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .gallery-grid {
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1rem;
    }

    .lightbox-nav {
      width: 44px;
      height: 44px;
    }

    .lightbox-nav.prev {
      left: 0.5rem;
    }

    .lightbox-nav.next {
      right: 0.5rem;
    }
  }
</style>